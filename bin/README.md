# Minecraft Server Update Scripts

This directory contains scripts for managing updates to your Minecraft server, Fabric loader, and mods.

## Environment Setup

The scripts support loading configuration from a `.env` file for convenience. This is especially useful for API keys and other sensitive information.

### Setting up .env file

1. Copy the example file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` and add your API keys:
   ```bash
   # .env file
   CURSEFORGE_API_KEY=your_curseforge_api_key_here
   ```

3. The `.env` file is automatically loaded by all scripts
4. Environment variables set in your shell take precedence over `.env` values

**Note:** The `.env` file is gitignored to prevent accidentally committing API keys.

### Alternative: System Environment Variables

You can also set environment variables directly in your shell:

```bash
# Linux/Mac
export CURSEFORGE_API_KEY=your_key_here

# Windows (PowerShell)
$env:CURSEFORGE_API_KEY="your_key_here"

# Windows (CMD)
set CURSEFORGE_API_KEY=your_key_here
```

## Scripts

### check_updates.py

Checks for available updates and generates a JSON file with update information.

**Usage:**
```bash
# Check all components and save to updates.json
python bin/check_updates.py

# Check only specific components
python bin/check_updates.py --mods
python bin/check_updates.py --mc
python bin/check_updates.py --fabric

# Specify custom output file
python bin/check_updates.py --output my-updates.json

# Check for a specific Minecraft version
python bin/check_updates.py --mc-version 1.21.2

# Comprehensive compatibility check (RECOMMENDED)
# Tests newer MC versions with Fabric and all mods to find a fully compatible update
python bin/check_updates.py --full-check
python bin/check_updates.py --full-check --compat-output my-report.json
```

**Output:**

Standard check creates a JSON file (default: `updates.json`) containing:
- Minecraft server update information
- Fabric loader update information
- Mod update information with download URLs
- Timestamp of when the check was performed

Full compatibility check (`--full-check`) creates a JSON file (default: `compatibility_report.json`) containing:
- Whether a compatible update was found
- Target Minecraft and Fabric versions (if compatible)
- All mod versions compatible with the target configuration
- Number of versions tested
- Download URLs for all components

**How --full-check works:**
1. Finds the newest Minecraft release version
2. Checks if Fabric is available for that version
3. Tests each Fabric version with ALL configured mods
4. If any mod is incompatible, tries the next Fabric version
5. If no Fabric version works, tries the next older MC version
6. Stops at the first fully compatible configuration or when no compatible update exists
7. Generates a report that can be used directly with `apply_updates.py`

### apply_updates.py

Applies updates based on the JSON file generated by `check_updates.py`.

**Usage:**
```bash
# Dry run - see what would be updated without making changes
python bin/apply_updates.py --dry-run

# Apply all available updates
python bin/apply_updates.py

# Apply only mod updates
python bin/apply_updates.py --mods

# Use custom input file and mods directory
python bin/apply_updates.py --input my-updates.json --mods-dir /path/to/mods
```

**Features:**
- Downloads updated mod files automatically
- Shows what updates are available for Minecraft and Fabric (manual update required)
- Supports dry-run mode to preview changes
- Validates downloads before saving

### validate_config.py

Validates the config.yaml file structure and checks if specified versions exist on their sources. Can automatically fix version issues by updating config with latest compatible versions.

**Usage:**
```bash
# Validate the default config.yaml (read-only)
python bin/validate_config.py

# Validate and auto-fix version issues
python bin/validate_config.py --auto-fix

# Validate a custom config file
python bin/validate_config.py --config my-config.yaml

# Use custom mappings file
python bin/validate_config.py --mappings my-mappings.yaml
```

**What it validates:**
- YAML file syntax and structure
- Required sections (minecraft, fabric, mods)
- Required fields for each section (name is required, version is optional)
- Valid source names (mojang, fabric, modrinth, curseforge, custom)
- Minecraft version exists on Mojang servers
- Fabric version exists for the specified Minecraft version
- Mod versions exist on Modrinth/CurseForge (or custom URL is provided)
- Mod versions are compatible with Fabric loader
- Mod versions are compatible with the specified Minecraft version
- **Auto-resolves missing versions**: If a mod has no version field, automatically finds and sets the latest compatible version

**Supported mod sources:**
- **Modrinth**: Requires mod `slug` (optional if name matches slug)
- **CurseForge**: Requires `project_id` (numeric ID from CurseForge URL)
  - Requires API key: Add `CURSEFORGE_API_KEY` to `.env` file or set as environment variable
  - Get your API key from: https://console.curseforge.com/
- **Custom**: Requires `download_url` field

**Error states:**
- **PROJECT NOT FOUND**: Mod doesn't exist on the source (e.g., wrong slug/name/project_id)
- **VERSION NOT FOUND**: Mod exists but specified version doesn't exist
- **VERSION FOUND but not for Fabric**: Version exists but only for other loaders
- **VERSION FOUND but not for MC X.X.X**: Version exists but not compatible with your Minecraft version

**Auto-fix mode (--auto-fix):**
When enabled, the script will:
- Find the latest compatible version for mods where the version is wrong
- Update the config.yaml file automatically
- Fetch and store mod environment information (client/server/both)
- Show a summary of all changes made
- Only fixes mods that exist on the source (cannot fix "PROJECT NOT FOUND" errors)

**Missing version auto-resolution:**
You can omit the `version` field for mods, and the script will automatically:
- Find the latest compatible version for your Minecraft version and Fabric loader
- Add the version to your config.yaml
- Add environment information (client/server/both)
- Works in both normal and --auto-fix modes

Example:
```yaml
mods:
  # Version will be auto-resolved
  - name: "sodium"
    source: "modrinth"
```

After validation, it becomes:
```yaml
mods:
  - name: "sodium"
    source: "modrinth"
    version: "mc1.21.1-0.6.13-fabric"  # Auto-added
    environment: "client"  # Auto-added
```

**Environment detection:**
The script automatically detects and stores the mod environment:
- `server`: Mod only works on server side (placed in `mods/`)
- `client`: Mod only works on client side (placed in `mods/client/`)
- `both`: Mod works on both sides (copied to both `mods/` and `mods/client/`)

This information is used by the download script to place mods in the correct directories.

**Output:**
- Structure validation results
- Version availability checks for each component
- Detailed error messages differentiating between mod not found vs version not found
- Auto-fix summary showing all version updates
- Warnings for optional fields
- Exit code 0 on success, 1 on failure

**When to use:**
- Before building a new server
- After manually editing config.yaml
- When troubleshooting download issues
- To automatically update all mod versions to latest compatible
- As part of a CI/CD pipeline

### download.py

Downloads Minecraft server, Fabric loader, and mods based on config.yaml.

**Features:**
- Downloads Minecraft server JAR
- Downloads Fabric loader
- Downloads mods from Modrinth, CurseForge, or custom URLs
- Respects mod `environment` field to place mods in correct directories:
  - `server`: Downloaded to `mods/`
  - `client`: Downloaded to `mods/client/`
  - `both`: Downloaded to both `mods/` and `mods/client/`
- Caches download URLs for faster repeated downloads
- Removes old mod versions before downloading new ones

**CurseForge support:**
To download from CurseForge, you need:
1. Get API key from: https://console.curseforge.com/
2. Add to `.env` file: `CURSEFORGE_API_KEY=your_key_here`
   - Or set as environment variable (see Environment Setup section above)
3. Add mods with `source: curseforge` and `project_id` in config.yaml

**Usage:**
```bash
# Build download list and download all components
python bin/download.py

# Use cached download list
python bin/download.py

# Rebuild cache from config
python bin/download.py --rebuild-cache

# Use custom config/mappings files
python bin/download.py --config my-config.yaml --mappings my-mappings.yaml
```

### backup.sh

Creates a backup of the server data.

### shutdown.sh

Gracefully shuts down the Minecraft server.

## Config File Examples

### Basic config.yaml structure

```yaml
minecraft:
  version: "1.21.1"
  source: "mojang"

fabric:
  version: "0.16.9"
  source: "fabric"

mods:
  # Modrinth mod with explicit version
  - name: "sodium"
    version: "mc1.21.1-0.6.13-fabric"
    source: "modrinth"
    environment: "client"  # Added by validation script

  # Modrinth mod without version - auto-resolved by validation
  - name: "lithium"
    source: "modrinth"
    # version: auto-added by validation
    # environment: auto-added by validation

  # Modrinth mod with slug override
  - name: "fabric-api"
    version: "0.115.0+1.21.1"
    source: "modrinth"
    slug: "fabric-api"  # Optional
    environment: "both"

  # CurseForge mod (requires project_id)
  - name: "JEI"
    version: "19.8.3.119"  # Can be version name or file_id
    source: "curseforge"
    project_id: 238222  # From CurseForge URL
    file_id: 5629283  # Optional, added by validation
    environment: "both"

  # CurseForge mod without version - auto-resolved
  - name: "JourneyMap"
    source: "curseforge"
    project_id: 32274
    # version: auto-added by validation
    # file_id: auto-added by validation
    # environment: auto-added by validation

  # Custom direct download
  - name: "custom-mod"
    version: "1.0.0"
    source: "custom"
    download_url: "https://example.com/mod.jar"
    environment: "both"
```

### Finding CurseForge project_id

1. Go to the mod page on CurseForge
2. Look at the URL: `https://www.curseforge.com/minecraft/mc-mods/jei`
3. Click on a file, the URL becomes: `https://www.curseforge.com/minecraft/mc-mods/jei/files/5629283`
4. The project_id is shown in the API or you can use the file_id directly
5. Or use the CurseForge API to search: `https://api.curseforge.com/v1/mods/search?gameId=432&searchFilter=jei`

## Workflow

### Recommended: Full Compatibility Check

1. **Find a compatible update:**
   ```bash
   python bin/check_updates.py --full-check
   ```

2. **Review the compatibility report:**
   The script will show if a compatible update was found and save details to `compatibility_report.json`

3. **Preview the update (dry run):**
   ```bash
   python bin/apply_updates.py --input compatibility_report.json --dry-run
   ```

4. **Apply the update:**
   ```bash
   # Backup first
   ./bin/backup.sh

   # Download updated mods
   python bin/apply_updates.py --input compatibility_report.json --mods

   # Manually update config.yaml with the MC and Fabric versions from the report
   # Then rebuild the server
   ```

### Alternative: Standard Update Check

1. **Check for updates:**
   ```bash
   python bin/check_updates.py
   ```

2. **Review the updates:**
   ```bash
   # Preview what will be updated
   python bin/apply_updates.py --dry-run
   ```

3. **Apply updates:**
   ```bash
   # Update only mods automatically
   python bin/apply_updates.py --mods

   # For Minecraft/Fabric updates, manually update config.yaml
   # then rebuild the server
   ```

4. **Backup before applying:**
   ```bash
   ./bin/backup.sh
   python bin/apply_updates.py
   ```

## Output File Formats

### Standard Update Check (`updates.json`)

```json
{
  "timestamp": "2025-11-08T10:30:00.000000",
  "minecraft": {
    "current_version": "1.20.1",
    "latest_version": "1.21.2",
    "has_update": true,
    "newer_versions": ["1.21.2", "1.21.1", "1.21"]
  },
  "fabric": {
    "current_version": "0.15.0",
    "latest_version": "0.16.0",
    "has_update": true,
    "newer_versions": ["0.16.0", "0.15.11"]
  },
  "mods": {
    "ModName": {
      "current_version": "1.0.0",
      "latest_version": "1.1.0",
      "download_url": "https://cdn.modrinth.com/..."
    }
  }
}
```

### Full Compatibility Check (`compatibility_report.json`)

```json
{
  "timestamp": "2025-11-08T10:30:00.000000",
  "compatible_update_found": true,
  "update_type": "full_compatibility_check",
  "minecraft": {
    "current_version": "1.20.1",
    "target_version": "1.21.0"
  },
  "fabric": {
    "current_version": "0.15.0",
    "target_version": "0.16.0"
  },
  "mods": {
    "ModName": {
      "version": "1.1.0",
      "download_url": "https://cdn.modrinth.com/...",
      "project_id": "abc123"
    }
  },
  "tested_versions": {
    "mc_versions_tested": 2,
    "fabric_versions_tested": 1
  }
}
```

If no compatible update is found:

```json
{
  "timestamp": "2025-11-08T10:30:00.000000",
  "compatible_update_found": false,
  "message": "No compatible update configuration found"
}
```

## Requirements

- Python 3.7+
- PyYAML (for config file parsing)
- Internet connection (for checking/downloading updates)
